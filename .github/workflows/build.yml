name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-arch-full:
    name: Arch Linux (Wayland + X11)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git wayland wayland-protocols \
            egl-wayland mesa libpng libjpeg-turbo libx11 libxrandr

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build
        run: make

      - name: Check binary
        run: |
          test -f build/bin/neowall
          ./build/bin/neowall --version
          ./build/bin/neowall --help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: neowall-arch-full
          path: build/bin/neowall

  build-arch-wayland-only:
    name: Arch Linux (Wayland only)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Update system and install dependencies (no X11)
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git wayland wayland-protocols \
            egl-wayland mesa libpng libjpeg-turbo

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build (Wayland only)
        run: make X11_BACKEND=no

      - name: Verify X11 backend not compiled
        run: |
          make X11_BACKEND=no 2>&1 | grep -q "X11 backend disabled" && echo "X11 correctly disabled"

      - name: Check binary
        run: |
          test -f build/bin/neowall
          ./build/bin/neowall --version

  build-arch-x11-only:
    name: Arch Linux (X11 only)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Update system and install dependencies (no Wayland)
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git mesa libpng libjpeg-turbo \
            libx11 libxrandr

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build (X11 only)
        run: make WAYLAND_BACKEND=no

      - name: Verify Wayland backend not compiled
        run: |
          make WAYLAND_BACKEND=no 2>&1 | grep -q "Wayland backend disabled" && echo "Wayland correctly disabled"

      - name: Check binary
        run: |
          test -f build/bin/neowall
          ./build/bin/neowall --version

  build-debian-x11-only:
    name: Debian (X11 only - i3 style)
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    steps:
      - name: Install dependencies (pure X11, no Wayland)
        run: |
          apt-get update
          apt-get install -y build-essential git pkg-config \
            libx11-dev libxrandr-dev \
            libegl1-mesa-dev libgles2-mesa-dev \
            libpng-dev libjpeg-dev

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build (X11 only)
        run: make WAYLAND_BACKEND=no

      - name: Verify Wayland backend not compiled
        run: |
          make WAYLAND_BACKEND=no 2>&1 | grep -q "Wayland backend disabled" && echo "Wayland correctly disabled"

      - name: Verify X11 backend compiled
        run: |
          make WAYLAND_BACKEND=no 2>&1 | grep -q "X11 backend available" && echo "X11 backend enabled"

      - name: Check binary
        run: |
          test -f build/bin/neowall
          ./build/bin/neowall --version